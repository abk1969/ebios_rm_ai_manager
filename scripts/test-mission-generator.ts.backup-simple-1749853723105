#!/usr/bin/env tsx

/**
 * Script de test pour le gÃ©nÃ©rateur automatique de missions EBIOS RM
 */

import { AutoMissionGeneratorService } from '../src/services/ai/AutoMissionGeneratorService';

async function testMissionGenerator() {
  console.log('ğŸ§ª Test du gÃ©nÃ©rateur automatique de missions EBIOS RM');
  console.log('=' .repeat(60));

  try {
    // Contexte de test pour une organisation de santÃ©
    const testContext = {
      organizationName: 'Centre Hospitalier Universitaire de Test',
      sector: 'SantÃ© - Ã‰tablissements hospitaliers privÃ©s',
      organizationSize: 'Grande entreprise - GE (5000+ employÃ©s)',
      geographicScope: 'national',
      criticalityLevel: 'high',
      siComponents: [
        'ERP - SAP (S/4HANA, ECC)',
        'Infrastructure Cloud - Microsoft Azure',
        'Active Directory / LDAP',
        'SIEM (Security Information)'
      ],
      mainTechnologies: [
        'Microsoft Azure',
        'SAP S/4HANA',
        'Active Directory'
      ],
      externalInterfaces: [],
      sensitiveData: [],
      criticalProcesses: [
        'Gestion des dossiers patients',
        'SystÃ¨me de facturation',
        'Gestion des rendez-vous',
        'Pharmacie hospitaliÃ¨re'
      ],
      stakeholders: [
        'Patients',
        'Personnel mÃ©dical',
        'Administration',
        'CNIL',
        'ARS'
      ],
      regulations: [
        'RGPD (RÃ¨glement GÃ©nÃ©ral sur la Protection des DonnÃ©es)',
        'HDS (HÃ©bergement de DonnÃ©es de SantÃ©)',
        'ISO 27001 (Management de la sÃ©curitÃ©)'
      ],
      financialStakes: 'Ã‰levÃ© - Budget annuel > 100Mâ‚¬',
      securityMaturity: 'intermediate',
      pastIncidents: '',
      regulatoryConstraints: [
        'RGPD (RÃ¨glement GÃ©nÃ©ral sur la Protection des DonnÃ©es)',
        'HDS (HÃ©bergement de DonnÃ©es de SantÃ©)'
      ],
      securityBudget: '2-5% du budget IT',
      missionObjectives: [
        'ConformitÃ© rÃ©glementaire RGPD/HDS',
        'Protection des donnÃ©es de santÃ©',
        'ContinuitÃ© des soins',
        'AmÃ©lioration de la posture sÃ©curitÃ©'
      ],
      timeframe: '6 months',
      specificRequirements: 'Certification HDS obligatoire, audit ANSSI requis'
    };

    console.log('ğŸ“‹ Contexte de test:');
    console.log(`   Organisation: ${testContext.organizationName}`);
    console.log(`   Secteur: ${testContext.sector}`);
    console.log(`   Taille: ${testContext.organizationSize}`);
    console.log(`   Composants SI: ${testContext.siComponents.length} Ã©lÃ©ments`);
    console.log(`   Processus critiques: ${testContext.criticalProcesses.length} Ã©lÃ©ments`);
    console.log(`   RÃ©glementations: ${testContext.regulations.length} Ã©lÃ©ments`);
    console.log('');

    // Test du service
    console.log('ğŸš€ Lancement de la gÃ©nÃ©ration...');
    const service = AutoMissionGeneratorService.getInstance();
    
    const startTime = Date.now();
    const result = await service.generateMission(testContext);
    const endTime = Date.now();

    console.log('');
    console.log('âœ… GÃ©nÃ©ration terminÃ©e avec succÃ¨s !');
    console.log(`â±ï¸  Temps d'exÃ©cution: ${(endTime - startTime) / 1000}s`);
    console.log('');
    console.log('ğŸ“Š RÃ©sultats:');
    console.log(`   Mission ID: ${result.missionId}`);
    console.log(`   Biens essentiels: ${result.businessValues.length} gÃ©nÃ©rÃ©s`);
    console.log(`   Biens supports: ${result.supportingAssets.length} gÃ©nÃ©rÃ©s`);
    console.log(`   Ã‰vÃ©nements redoutÃ©s: ${result.dreadedEvents.length} gÃ©nÃ©rÃ©s`);
    console.log(`   Sources de risque: ${result.riskSources.length} gÃ©nÃ©rÃ©s`);
    console.log(`   ScÃ©narios stratÃ©giques: ${result.strategicScenarios.length} gÃ©nÃ©rÃ©s`);
    console.log(`   ScÃ©narios opÃ©rationnels: ${result.operationalScenarios.length} gÃ©nÃ©rÃ©s`);
    console.log(`   Mesures de sÃ©curitÃ©: ${result.securityMeasures.length} gÃ©nÃ©rÃ©s`);
    console.log(`   Rapports: ${result.reports.length} gÃ©nÃ©rÃ©s`);
    console.log('');

    // Affichage des dÃ©tails des biens essentiels
    if (result.businessValues.length > 0) {
      console.log('ğŸ¯ Biens essentiels gÃ©nÃ©rÃ©s:');
      result.businessValues.forEach((bv, index) => {
        console.log(`   ${index + 1}. ${bv.name}`);
        console.log(`      CriticitÃ©: ${bv.criticalityLevel}/4`);
        console.log(`      Impacts: ${bv.impactTypes.join(', ')}`);
      });
      console.log('');
    }

    // Affichage des dÃ©tails des Ã©vÃ©nements redoutÃ©s
    if (result.dreadedEvents.length > 0) {
      console.log('âš ï¸  Ã‰vÃ©nements redoutÃ©s gÃ©nÃ©rÃ©s:');
      result.dreadedEvents.forEach((de, index) => {
        console.log(`   ${index + 1}. ${de.name}`);
        console.log(`      Impact: ${de.impactLevel}/4`);
        console.log(`      ConsÃ©quences: ${de.consequences.length} identifiÃ©es`);
      });
      console.log('');
    }

    console.log('ğŸ‰ Test terminÃ© avec succÃ¨s !');
    console.log('');
    console.log('ğŸ’¡ La mission peut maintenant Ãªtre consultÃ©e dans l\'interface web');
    console.log(`   URL: http://localhost:5177/missions/${result.missionId}`);

  } catch (error) {
    console.error('âŒ Erreur lors du test:', error);
    console.error('');
    console.error('ğŸ” DÃ©tails de l\'erreur:');
    if (error instanceof Error) {
      console.error(`   Message: ${error.message}`);
      console.error(`   Stack: ${error.stack}`);
    }
    process.exit(1);
  }
}

// ExÃ©cution du test
testMissionGenerator().catch(console.error);

export { testMissionGenerator };
