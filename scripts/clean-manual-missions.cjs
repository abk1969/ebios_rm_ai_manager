/**
 * ğŸ—‘ï¸ NETTOYAGE SÃ‰CURISÃ‰ DES MISSIONS CRÃ‰Ã‰ES MANUELLEMENT
 * Script pour supprimer uniquement les missions crÃ©Ã©es manuellement
 * tout en prÃ©servant les missions gÃ©nÃ©rÃ©es automatiquement
 */

const { initializeApp } = require('firebase/app');
const { getFirestore, collection, getDocs, deleteDoc, doc, query, where } = require('firebase/firestore');

// Configuration Firebase (Ã€ REMPLACER PAR VOS VRAIES VALEURS)
const firebaseConfig = {
  apiKey: process.env.VITE_FIREBASE_API_KEY || "your_firebase_api_key_here",
  authDomain: process.env.VITE_FIREBASE_AUTH_DOMAIN || "your-project.firebaseapp.com",
  projectId: process.env.VITE_FIREBASE_PROJECT_ID || "your_project_id",
  storageBucket: process.env.VITE_FIREBASE_STORAGE_BUCKET || "your-project.firebasestorage.app",
  messagingSenderId: process.env.VITE_FIREBASE_MESSAGING_SENDER_ID || "your_sender_id",
  appId: process.env.VITE_FIREBASE_APP_ID || "your_app_id"
};

// Initialisation Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function cleanManualMissions() {
  console.log('ğŸ” ANALYSE DES MISSIONS EXISTANTES');
  console.log('=====================================');

  try {
    // RÃ©cupÃ©rer toutes les missions
    const missionsRef = collection(db, 'missions');
    const snapshot = await getDocs(missionsRef);
    
    console.log(`ğŸ“Š Total missions trouvÃ©es: ${snapshot.size}`);
    
    if (snapshot.empty) {
      console.log('âœ… Aucune mission trouvÃ©e - Base dÃ©jÃ  propre');
      return;
    }

    const missions = [];
    const manualMissions = [];
    const autoMissions = [];

    snapshot.forEach(doc => {
      const data = doc.data();
      const mission = {
        id: doc.id,
        name: data.name || 'Sans nom',
        description: data.description || '',
        createdAt: data.createdAt?.toDate?.()?.toISOString() || 'Date inconnue',
        organizationContext: data.organizationContext || {},
        // Indicateur de gÃ©nÃ©ration automatique
        isAutoGenerated: data.isAutoGenerated || false,
        generatedBy: data.generatedBy || null
      };
      
      missions.push(mission);

      // Classification : Auto vs Manuel
      if (mission.isAutoGenerated || mission.generatedBy === 'AutoMissionGeneratorService') {
        autoMissions.push(mission);
      } else {
        manualMissions.push(mission);
      }
    });

    console.log('\nğŸ“‹ CLASSIFICATION DES MISSIONS:');
    console.log(`ğŸ¤– Missions automatiques: ${autoMissions.length}`);
    console.log(`ğŸ‘¤ Missions manuelles: ${manualMissions.length}`);

    // Afficher les dÃ©tails
    if (autoMissions.length > 0) {
      console.log('\nğŸ¤– MISSIONS AUTOMATIQUES (Ã€ PRÃ‰SERVER):');
      autoMissions.forEach((mission, index) => {
        console.log(`   ${index + 1}. "${mission.name}" (${mission.id})`);
        console.log(`      ğŸ“… CrÃ©Ã©e: ${mission.createdAt}`);
        console.log(`      ğŸ¢ Organisation: ${mission.organizationContext?.organizationType || 'Non dÃ©finie'}`);
      });
    }

    if (manualMissions.length > 0) {
      console.log('\nğŸ‘¤ MISSIONS MANUELLES (Ã€ SUPPRIMER):');
      manualMissions.forEach((mission, index) => {
        console.log(`   ${index + 1}. "${mission.name}" (${mission.id})`);
        console.log(`      ğŸ“… CrÃ©Ã©e: ${mission.createdAt}`);
        console.log(`      ğŸ“ Description: ${mission.description.substring(0, 50)}${mission.description.length > 50 ? '...' : ''}`);
      });

      console.log('\nğŸš¨ SUPPRESSION DES MISSIONS MANUELLES...');
      
      let deletedCount = 0;
      for (const mission of manualMissions) {
        try {
          await deleteDoc(doc(db, 'missions', mission.id));
          console.log(`   âœ… SupprimÃ©e: "${mission.name}" (${mission.id})`);
          deletedCount++;
        } catch (error) {
          console.error(`   âŒ Erreur suppression "${mission.name}":`, error.message);
        }
      }

      console.log(`\nğŸ‰ NETTOYAGE TERMINÃ‰: ${deletedCount}/${manualMissions.length} missions supprimÃ©es`);
    } else {
      console.log('\nâœ… Aucune mission manuelle trouvÃ©e - Rien Ã  supprimer');
    }

    // VÃ©rification finale
    console.log('\nğŸ” VÃ‰RIFICATION FINALE...');
    const finalSnapshot = await getDocs(missionsRef);
    console.log(`ğŸ“Š Missions restantes: ${finalSnapshot.size}`);
    
    if (finalSnapshot.size === autoMissions.length) {
      console.log('âœ… SUCCÃˆS: Seules les missions automatiques sont conservÃ©es');
    } else {
      console.log('âš ï¸  ATTENTION: Nombre de missions restantes inattendu');
    }

  } catch (error) {
    console.error('âŒ ERREUR lors du nettoyage:', error);
    throw error;
  }
}

// Fonction de vÃ©rification avant suppression
async function verifyBeforeClean() {
  console.log('ğŸ›¡ï¸  VÃ‰RIFICATION DE SÃ‰CURITÃ‰');
  console.log('============================');
  
  try {
    const missionsRef = collection(db, 'missions');
    const snapshot = await getDocs(missionsRef);
    
    if (snapshot.empty) {
      console.log('â„¹ï¸  Aucune mission trouvÃ©e');
      return false;
    }

    console.log(`ğŸ“Š ${snapshot.size} mission(s) trouvÃ©e(s)`);
    
    let hasManualMissions = false;
    snapshot.forEach(doc => {
      const data = doc.data();
      const isAuto = data.isAutoGenerated || data.generatedBy === 'AutoMissionGeneratorService';
      if (!isAuto) {
        hasManualMissions = true;
      }
    });

    if (!hasManualMissions) {
      console.log('âœ… Aucune mission manuelle dÃ©tectÃ©e');
      return false;
    }

    return true;
  } catch (error) {
    console.error('âŒ Erreur lors de la vÃ©rification:', error);
    return false;
  }
}

// ExÃ©cution principale
async function main() {
  console.log('ğŸ—‘ï¸  NETTOYAGE SÃ‰CURISÃ‰ DES MISSIONS MANUELLES');
  console.log('==============================================');
  console.log('ğŸ¯ OBJECTIF: Supprimer uniquement les missions crÃ©Ã©es manuellement');
  console.log('ğŸ›¡ï¸  SÃ‰CURITÃ‰: PrÃ©server les missions gÃ©nÃ©rÃ©es automatiquement');
  console.log('');

  try {
    // VÃ©rification prÃ©alable
    const shouldProceed = await verifyBeforeClean();
    
    if (!shouldProceed) {
      console.log('ğŸ ARRÃŠT: Aucune action nÃ©cessaire');
      return;
    }

    // Nettoyage
    await cleanManualMissions();
    
    console.log('\nğŸ‰ NETTOYAGE TERMINÃ‰ AVEC SUCCÃˆS !');
    console.log('âœ… Base de donnÃ©es prÃªte pour les nouvelles missions avec contexte');
    
  } catch (error) {
    console.error('\nğŸ’¥ Ã‰CHEC DU NETTOYAGE:', error);
    process.exit(1);
  }
}

// Lancement du script
if (require.main === module) {
  main().catch(console.error);
}

module.exports = { cleanManualMissions, verifyBeforeClean };
