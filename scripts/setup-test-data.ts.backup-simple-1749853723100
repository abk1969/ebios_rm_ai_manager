#!/usr/bin/env tsx

/**
 * ğŸ¯ SCRIPT DE SETUP DES DONNÃ‰ES DE TEST RÃ‰ELLES
 * Initialise une base de donnÃ©es Firebase avec des donnÃ©es de test complÃ¨tes
 */

import { RealTestDataService } from '../src/services/test-data/RealTestDataService';
import { FirebaseTestUtils } from '../src/config/firebase.test';

async function setupTestData() {
  console.log('ğŸš€ SETUP DES DONNÃ‰ES DE TEST RÃ‰ELLES');
  console.log('=====================================\n');

  try {
    // 1. VÃ©rifier la connexion Firebase
    console.log('ğŸ”¥ VÃ©rification de la connexion Firebase...');
    const isConnected = await FirebaseTestUtils.checkConnection();
    
    if (!isConnected) {
      console.error('âŒ Impossible de se connecter Ã  Firebase');
      console.log('ğŸ’¡ VÃ©rifiez votre configuration Firebase dans .env.production');
      process.exit(1);
    }
    
    console.log('âœ… Connexion Firebase Ã©tablie\n');

    // 2. Initialiser le service de donnÃ©es de test
    const testDataService = RealTestDataService.getInstance();

    // 3. Nettoyer les donnÃ©es existantes
    console.log('ğŸ§¹ Nettoyage des donnÃ©es de test existantes...');
    await testDataService.cleanupAllTestData();
    console.log('âœ… Nettoyage terminÃ©\n');

    // 4. CrÃ©er des missions de test
    console.log('ğŸ—ï¸ CrÃ©ation des missions de test...');
    
    const missions = [
      'Mission Test - Banque en ligne',
      'Mission Test - E-commerce',
      'Mission Test - SystÃ¨me de santÃ©',
      'Mission Test - Administration publique',
      'Mission Test - Industrie critique'
    ];

    const createdMissions: string[] = [];

    for (const missionName of missions) {
      console.log(`  ğŸ“ CrÃ©ation: ${missionName}`);
      const missionId = await testDataService.createTestMission(missionName);
      createdMissions.push(missionId);
      console.log(`  âœ… CrÃ©Ã©e avec ID: ${missionId}`);
    }

    console.log(`\nğŸ¯ ${createdMissions.length} missions de test crÃ©Ã©es avec succÃ¨s`);

    // 5. Afficher le rÃ©sumÃ©
    console.log('\nğŸ“Š RÃ‰SUMÃ‰ DES DONNÃ‰ES CRÃ‰Ã‰ES');
    console.log('============================');
    console.log(`Missions: ${createdMissions.length}`);
    console.log('Chaque mission contient:');
    console.log('  â€¢ 4 biens essentiels');
    console.log('  â€¢ 6 biens supports');
    console.log('  â€¢ 3 Ã©vÃ©nements redoutÃ©s');
    console.log('  â€¢ 2 sources de risque');
    console.log('  â€¢ 1 scÃ©nario stratÃ©gique');
    console.log('  â€¢ 1 scÃ©nario opÃ©rationnel');
    console.log('  â€¢ 2 mesures de sÃ©curitÃ©');

    console.log('\nğŸ”§ UTILISATION');
    console.log('===============');
    console.log('Pour lancer les tests avec donnÃ©es rÃ©elles:');
    console.log('  npm run test:realdata');
    console.log('\nPour nettoyer les donnÃ©es:');
    console.log('  npm run cleanup:testdata');

    console.log('\nâœ… Setup terminÃ© avec succÃ¨s !');

  } catch (error) {
    console.error('âŒ Erreur lors du setup:', error);
    process.exit(1);
  }
}

async function cleanupTestData() {
  console.log('ğŸ§¹ NETTOYAGE DES DONNÃ‰ES DE TEST');
  console.log('=================================\n');

  try {
    const testDataService = RealTestDataService.getInstance();
    await testDataService.cleanupAllTestData();
    console.log('âœ… Nettoyage terminÃ© avec succÃ¨s !');
  } catch (error) {
    console.error('âŒ Erreur lors du nettoyage:', error);
    process.exit(1);
  }
}

// Gestion des arguments de ligne de commande
const command = process.argv[2];

switch (command) {
  case 'setup':
    setupTestData();
    break;
  case 'cleanup':
    cleanupTestData();
    break;
  default:
    setupTestData();
    break;
}
