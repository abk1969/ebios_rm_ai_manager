rules_version = '2';

/**
 * ðŸ”’ RÃˆGLES FIREBASE SÃ‰CURISÃ‰ES POUR PRODUCTION
 * ConformitÃ© ANSSI - ContrÃ´le d'accÃ¨s granulaire, audit, intÃ©gritÃ©
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ðŸ”§ FONCTIONS UTILITAIRES DE SÃ‰CURITÃ‰
    
    // VÃ©rification de l'authentification
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // VÃ©rification de l'email vÃ©rifiÃ©
    function isEmailVerified() {
      return request.auth != null && request.auth.token.email_verified == true;
    }
    
    // VÃ©rification du rÃ´le utilisateur
    function hasRole(role) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    // VÃ©rification des permissions multiples rÃ´les
    function hasAnyRole(roles) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in roles;
    }
    
    // VÃ©rification de l'appartenance Ã  une mission
    function isMissionMember(missionId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/missions/$(missionId)) &&
             (get(/databases/$(database)/documents/missions/$(missionId)).data.assignedTo is list &&
              request.auth.uid in get(/databases/$(database)/documents/missions/$(missionId)).data.assignedTo ||
              get(/databases/$(database)/documents/missions/$(missionId)).data.createdBy == request.auth.uid);
    }
    
    // VÃ©rification du propriÃ©taire de ressource
    function isOwner(resource) {
      return resource.data.createdBy == request.auth.uid;
    }
    
    // VÃ©rification de l'assignation
    function isAssigned(resource) {
      return resource.data.assignedTo is list && 
             request.auth.uid in resource.data.assignedTo;
    }
    
    // VÃ©rification de l'intÃ©gritÃ© des donnÃ©es
    function isValidUpdate() {
      return request.resource.data.updatedAt is timestamp &&
             request.resource.data.updatedBy == request.auth.uid;
    }
    
    // VÃ©rification de la session MFA
    function isMFAVerified() {
      return request.auth != null && 
             request.auth.token.mfa_verified == true;
    }
    
    // VÃ©rification des heures d'accÃ¨s (9h-18h)
    function isBusinessHours() {
      let hour = request.time.toMillis() / 1000 / 3600 % 24;
      return hour >= 9 && hour <= 18;
    }

    // ðŸ‘¤ GESTION DES UTILISATEURS
    match /users/{userId} {
      // Lecture : utilisateur lui-mÃªme ou admins
      allow read: if isAuthenticated() && 
                     (request.auth.uid == userId || hasAnyRole(['admin', 'superadmin']));
      
      // CrÃ©ation : seulement les admins
      allow create: if hasAnyRole(['admin', 'superadmin']) && 
                       isEmailVerified() &&
                       isMFAVerified() &&
                       request.resource.data.keys().hasAll(['email', 'role', 'createdAt', 'createdBy']) &&
                       request.resource.data.createdBy == request.auth.uid;
      
      // Modification : utilisateur lui-mÃªme (donnÃ©es limitÃ©es) ou admins
      allow update: if isAuthenticated() && 
                       isValidUpdate() &&
                       ((request.auth.uid == userId && 
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['displayName', 'company', 'firstName', 'lastName', 'updatedAt', 'updatedBy'])) ||
                        (hasAnyRole(['admin', 'superadmin']) && isMFAVerified()));
      
      // Suppression : seulement superadmin avec MFA
      allow delete: if hasRole('superadmin') && isMFAVerified();
    }

    // ðŸ“‹ MISSIONS EBIOS RM
    match /missions/{missionId} {
      // Lecture : membres de la mission, analystes, auditeurs, admins
      allow read: if isAuthenticated() && 
                     (isMissionMember(missionId) || 
                      hasAnyRole(['analyst', 'auditor', 'admin', 'superadmin']));
      
      // CrÃ©ation : analystes et admins uniquement
      allow create: if hasAnyRole(['analyst', 'admin', 'superadmin']) && 
                       isEmailVerified() &&
                       request.resource.data.keys().hasAll(['name', 'description', 'status', 'createdAt', 'createdBy', 'assignedTo']) &&
                       request.resource.data.createdBy == request.auth.uid &&
                       request.auth.uid in request.resource.data.assignedTo;
      
      // Modification : membres de la mission avec restrictions
      allow update: if isAuthenticated() && 
                       isValidUpdate() &&
                       (isMissionMember(missionId) || hasAnyRole(['admin', 'superadmin'])) &&
                       // EmpÃªcher la modification des champs critiques sans admin
                       (hasAnyRole(['admin', 'superadmin']) || 
                        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['assignedTo', 'status', 'ebiosCompliance']));
      
      // Suppression : seulement crÃ©ateur ou admin avec MFA
      allow delete: if isAuthenticated() && 
                       isMFAVerified() &&
                       (isOwner(resource) || hasAnyRole(['admin', 'superadmin']));

      // ðŸ› ï¸ SOUS-COLLECTIONS DES MISSIONS
      
      // Ateliers (workshops)
      match /workshops/{workshopId} {
        allow read: if isMissionMember(missionId) || hasAnyRole(['auditor', 'admin', 'superadmin']);
        allow write: if isMissionMember(missionId) && isValidUpdate();
      }
      
      // Biens essentiels
      match /businessValues/{valueId} {
        allow read: if isMissionMember(missionId) || hasAnyRole(['auditor', 'admin', 'superadmin']);
        allow write: if isMissionMember(missionId) && isValidUpdate();
      }
      
      // Biens supports
      match /supportingAssets/{assetId} {
        allow read: if isMissionMember(missionId) || hasAnyRole(['auditor', 'admin', 'superadmin']);
        allow write: if isMissionMember(missionId) && isValidUpdate();
      }
      
      // Ã‰vÃ©nements redoutÃ©s
      match /dreadedEvents/{eventId} {
        allow read: if isMissionMember(missionId) || hasAnyRole(['auditor', 'admin', 'superadmin']);
        allow write: if isMissionMember(missionId) && isValidUpdate();
      }
      
      // ScÃ©narios stratÃ©giques
      match /strategicScenarios/{scenarioId} {
        allow read: if isMissionMember(missionId) || hasAnyRole(['auditor', 'admin', 'superadmin']);
        allow write: if isMissionMember(missionId) && isValidUpdate();
      }
      
      // ScÃ©narios opÃ©rationnels
      match /operationalScenarios/{scenarioId} {
        allow read: if isMissionMember(missionId) || hasAnyRole(['auditor', 'admin', 'superadmin']);
        allow write: if isMissionMember(missionId) && isValidUpdate();
      }
      
      // Mesures de sÃ©curitÃ©
      match /securityMeasures/{measureId} {
        allow read: if isMissionMember(missionId) || hasAnyRole(['auditor', 'admin', 'superadmin']);
        allow write: if isMissionMember(missionId) && isValidUpdate();
      }
    }

    // ðŸ“Š RAPPORTS
    match /reports/{reportId} {
      // Lecture : selon la visibilitÃ© du rapport
      allow read: if isAuthenticated() && 
                     (resource.data.visibility == 'public' ||
                      isOwner(resource) ||
                      (resource.data.missionId != null && isMissionMember(resource.data.missionId)) ||
                      hasAnyRole(['auditor', 'admin', 'superadmin']));
      
      // CrÃ©ation : analystes et admins
      allow create: if hasAnyRole(['analyst', 'admin', 'superadmin']) && 
                       isEmailVerified() &&
                       request.resource.data.createdBy == request.auth.uid;
      
      // Modification : propriÃ©taire ou admin
      allow update: if isAuthenticated() && 
                       isValidUpdate() &&
                       (isOwner(resource) || hasAnyRole(['admin', 'superadmin']));
      
      // Suppression : propriÃ©taire ou admin avec MFA
      allow delete: if isAuthenticated() && 
                       isMFAVerified() &&
                       (isOwner(resource) || hasAnyRole(['admin', 'superadmin']));
    }

    // ðŸ” DONNÃ‰ES DE SÃ‰CURITÃ‰ (accÃ¨s trÃ¨s restreint)
    
    // Sessions utilisateur
    match /sessions/{sessionId} {
      allow read, write: if isAuthenticated() && 
                            resource.data.userId == request.auth.uid;
    }
    
    // Configuration MFA
    match /mfa_setup/{userId} {
      allow read, write: if isAuthenticated() && 
                            request.auth.uid == userId;
    }
    
    // ClÃ©s de chiffrement (lecture seule pour le systÃ¨me)
    match /encryption_keys/{keyId} {
      allow read: if hasRole('superadmin') && isMFAVerified();
      allow write: if false; // GÃ©rÃ© uniquement par les fonctions Cloud
    }

    // ðŸ“‹ AUDIT ET CONFORMITÃ‰ (lecture seule pour la plupart)
    
    // Logs d'audit
    match /audit_logs/{logId} {
      allow read: if hasAnyRole(['auditor', 'admin', 'superadmin']) && isMFAVerified();
      allow write: if false; // GÃ©rÃ© uniquement par le systÃ¨me
    }
    
    // MÃ©triques de sÃ©curitÃ©
    match /security_metrics/{metricId} {
      allow read: if hasAnyRole(['auditor', 'admin', 'superadmin']);
      allow write: if false; // GÃ©rÃ© uniquement par le systÃ¨me
    }
    
    // Alertes de sÃ©curitÃ©
    match /security_alerts/{alertId} {
      allow read: if hasAnyRole(['auditor', 'admin', 'superadmin']);
      allow update: if hasAnyRole(['auditor', 'admin', 'superadmin']) && 
                       isValidUpdate() &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'acknowledgedBy', 'acknowledgedAt', 'resolvedBy', 'resolvedAt', 'updatedAt', 'updatedBy']);
      allow create, delete: if false; // GÃ©rÃ© uniquement par le systÃ¨me
    }
    
    // Incidents de sÃ©curitÃ©
    match /security_incidents/{incidentId} {
      allow read: if hasAnyRole(['auditor', 'admin', 'superadmin']) && isMFAVerified();
      allow update: if hasAnyRole(['admin', 'superadmin']) && 
                       isMFAVerified() &&
                       isValidUpdate();
      allow create, delete: if false; // GÃ©rÃ© uniquement par le systÃ¨me
    }
    
    // Anomalies de sÃ©curitÃ©
    match /security_anomalies/{anomalyId} {
      allow read: if hasAnyRole(['auditor', 'admin', 'superadmin']);
      allow write: if false; // GÃ©rÃ© uniquement par le systÃ¨me
    }
    
    // Rapports de conformitÃ©
    match /compliance_reports/{reportId} {
      allow read: if hasAnyRole(['auditor', 'admin', 'superadmin']);
      allow write: if false; // GÃ©rÃ© uniquement par le systÃ¨me
    }
    
    // Ã‰valuations de conformitÃ©
    match /compliance_assessments/{assessmentId} {
      allow read: if hasAnyRole(['auditor', 'admin', 'superadmin']);
      allow write: if false; // GÃ©rÃ© uniquement par le systÃ¨me
    }

    // ðŸš« RÃˆGLES PAR DÃ‰FAUT (DENY ALL)
    // Toute ressource non explicitement autorisÃ©e est interdite
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// ðŸ”’ RÃˆGLES POUR FIREBASE STORAGE
service firebase.storage {
  match /b/{bucket}/o {
    // Documents de mission
    match /missions/{missionId}/{allPaths=**} {
      allow read: if request.auth != null && 
                     (isMissionMember(missionId) || hasAnyRole(['auditor', 'admin', 'superadmin']));
      allow write: if request.auth != null && 
                      isMissionMember(missionId) &&
                      request.resource.size < 10 * 1024 * 1024 && // 10MB max
                      request.resource.contentType.matches('application/pdf|image/.*|text/.*');
    }
    
    // Rapports
    match /reports/{reportId}/{allPaths=**} {
      allow read: if request.auth != null && 
                     (isOwner(resource) || hasAnyRole(['auditor', 'admin', 'superadmin']));
      allow write: if request.auth != null && 
                      hasAnyRole(['analyst', 'admin', 'superadmin']) &&
                      request.resource.size < 50 * 1024 * 1024; // 50MB max
    }
    
    // Avatars utilisateur
    match /users/{userId}/avatar {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.size < 2 * 1024 * 1024 && // 2MB max
                      request.resource.contentType.matches('image/.*');
    }
    
    // Deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
